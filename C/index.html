<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puter AI Chat - Voice Enabled</title>
    <script src="https://js.puter.com/v2/"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; }
        
        .app-container { display: flex; height: 100vh; width: 100vw; }

        /* SIDEBAR */
        #sidebar {
            width: 280px;
            background-color: #202123;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
        }
        #sidebar h2 { font-size: 1.1rem; margin-bottom: 20px; color: #acacbe; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        #history-list { flex-grow: 1; }
        
        .history-item {
            padding: 10px;
            background: #343541;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: 0.2s;
        }
        .history-item:hover { background: #444654; }

        #clearBtn {
            background: #444;
            color: #ff9999;
            margin-top: 10px;
            font-size: 12px;
            padding: 8px;
            text-align: center;
        }

        /* MAIN AREA */
        #main-content { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 40px; overflow-y: auto; }
        #chat-window { width: 100%; max-width: 850px; }
        #questionInput { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        
        .button-group { display: flex; gap: 10px; }
        button { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; transition: 0.2s; }
        
        #submitButton { background-color: #007bff; color: white; }
        #stopButton { background-color: #dc3545; color: white; display: none; }
        
        /* VOICE BUTTON STYLES */
        #voiceButton { 
            background-color: #6c757d; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            min-width: 50px;
        }
        #voiceButton.listening {
            background-color: #dc3545;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        #result {
            background: white; padding: 25px; border-radius: 8px; margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); line-height: 1.6; min-height: 100px;
            white-space: pre-wrap;
        }

        /* CODE BLOCK STYLE */
        .code-container { position: relative; margin: 15px 0; }
        pre { background: #2d2d2d; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 0; }
        code { font-family: 'Consolas', monospace; color: #f8f8f2; }
        .copy-btn {
            position: absolute; top: 8px; right: 8px;
            background: #555; color: #fff; border: none;
            padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="sidebar">
            <h2>Saved Chats</h2>
            <div id="history-list"></div>
            <button id="clearBtn">ðŸ—‘ Clear All History</button>
        </div>

        <div id="main-content">
            <div id="chat-window">
                <h1>AI Workspace</h1>
                <input type="text" id="questionInput" placeholder="Ask a question or click the mic...">
                
                <div class="button-group">
                    <button id="submitButton">Ask AI</button>
                    <button id="voiceButton" title="Click to Speak">ðŸŽ¤</button>
                    <button id="stopButton">Stop</button>
                </div>

                <div id="result">Your answer will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        const inputElement = document.getElementById('questionInput');
        const submitBtn = document.getElementById('submitButton');
        const stopBtn = document.getElementById('stopButton');
        const voiceBtn = document.getElementById('voiceButton');
        const resultDiv = document.getElementById('result');
        const historyList = document.getElementById('history-list');
        const clearBtn = document.getElementById('clearBtn');

        let isGenerating = false;
        let chatHistory = [];

        // --- 1. INITIALIZE: Load from Local Storage ---
        window.onload = () => {
            const savedHistory = localStorage.getItem('puterChatHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                updateSidebar();
                if (chatHistory.length > 0) loadHistoryItem(0);
            }
            // Check Voice Support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                voiceBtn.style.display = 'none';
                console.warn("Speech Recognition not supported in this browser.");
            }
        };

        marked.setOptions({
            highlight: (code, lang) => {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            breaks: true
        });

        // --- VOICE RECOGNITION LOGIC ---
        let recognition;
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // "continuous = false" automatically stops capturing after a pause (silence)
            recognition.continuous = false; 
            recognition.lang = 'en-US'; 
            recognition.interimResults = false; // Only get final result

            recognition.onstart = () => {
                voiceBtn.classList.add('listening');
                inputElement.placeholder = "Listening...";
            };

            recognition.onend = () => {
                voiceBtn.classList.remove('listening');
                inputElement.placeholder = "Ask a question...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputElement.value = transcript;
                
                // Automatically hit send after receiving text
                console.log("Voice recognized: " + transcript);
                setTimeout(() => {
                    askAI();
                }, 500);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                voiceBtn.classList.remove('listening');
                inputElement.placeholder = "Error. Try again.";
            };

            voiceBtn.onclick = () => {
                if (voiceBtn.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            };
        }

        // --- AI LOGIC ---
        async function askAI() {
            const userQuestion = inputElement.value.trim();
            if (userQuestion === "" || isGenerating) return;

            isGenerating = true;
            submitBtn.disabled = true;
            stopBtn.style.display = "inline-block";
            voiceBtn.disabled = true; // Disable voice while generating
            resultDiv.innerHTML = "<em>Thinking...</em>";

            let fullText = "";

            try {
                // Using Puter.js
                const response = await puter.ai.chat(userQuestion, {
                    model: "gpt-4o-mini", // Faster model, good for chat
                    stream: true
                });

                resultDiv.innerText = "";

                for await (const part of response) {
                    if (!isGenerating) break;
                    if (part?.text) {
                        fullText += part.text;
                        resultDiv.innerText = fullText;
                    }
                }

                if (fullText) {
                    chatHistory.unshift({ question: userQuestion, answer: fullText });
                    localStorage.setItem('puterChatHistory', JSON.stringify(chatHistory));
                    updateSidebar();
                }

            } catch (error) {
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                renderFinalOutput(fullText);
                isGenerating = false;
                submitBtn.disabled = false;
                voiceBtn.disabled = false;
                stopBtn.style.display = "none";
                inputElement.value = "";
            }
        }

        function updateSidebar() {
            historyList.innerHTML = "";
            chatHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerText = item.question;
                div.onclick = () => loadHistoryItem(index);
                historyList.appendChild(div);
            });
        }

        function loadHistoryItem(index) {
            const item = chatHistory[index];
            renderFinalOutput(item.answer);
            inputElement.value = item.question;
        }

        function renderFinalOutput(text) {
            if (!text) return;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = marked.parse(text);

            tempDiv.querySelectorAll('pre').forEach((pre) => {
                const container = document.createElement('div');
                container.className = 'code-container';
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerText = 'Copy';
                btn.onclick = () => {
                    navigator.clipboard.writeText(pre.innerText);
                    btn.innerText = 'Copied!';
                    setTimeout(() => btn.innerText = 'Copy', 2000);
                };
                pre.parentNode.insertBefore(container, pre);
                container.appendChild(btn);
                container.appendChild(pre);
            });

            resultDiv.innerHTML = "";
            resultDiv.appendChild(tempDiv);
            resultDiv.querySelectorAll('pre code').forEach((el) => hljs.highlightElement(el));
        }

        // Action Listeners
        submitBtn.addEventListener('click', askAI);
        stopBtn.addEventListener('click', () => isGenerating = false);
        inputElement.addEventListener('keypress', (e) => { if (e.key === 'Enter') askAI(); });

        clearBtn.onclick = () => {
            if (confirm("Delete all saved chats?")) {
                localStorage.removeItem('puterChatHistory');
                chatHistory = [];
                updateSidebar();
                resultDiv.innerHTML = "History cleared.";
            }
        };
    </script>
</body>
</html>
