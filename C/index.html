<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puter AI - Authentic Search Engine</title>
    <script src="https://js.puter.com/v2/"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; }
        .app-container { display: flex; height: 100vh; width: 100vw; }

        /* SIDEBAR */
        #sidebar { width: 280px; background-color: #1a1a1b; color: #d7dadc; display: flex; flex-direction: column; padding: 15px; }
        #sidebar h2 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: #818384; margin-bottom: 20px; }
        .history-item { padding: 10px; background: #272729; border-radius: 4px; margin-bottom: 8px; cursor: pointer; font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; }
        
        /* MAIN AREA */
        #main-content { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        #chat-window { width: 100%; max-width: 900px; }
        
        #questionInput { width: 100%; padding: 18px; border: 1px solid #343536; background: white; border-radius: 8px; font-size: 16px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .status-indicator { font-size: 0.8rem; color: #007bff; margin-bottom: 10px; height: 20px; font-weight: bold; }
        
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        #submitButton { background-color: #007bff; color: white; }
        #stopButton { background-color: #ea4335; color: white; display: none; }

        #result { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); line-height: 1.7; min-height: 200px; }

        /* CODE & MARKDOWN */
        .code-container { position: relative; margin: 20px 0; }
        pre { background: #1e1e1e; padding: 15px; border-radius: 8px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; font-size: 14px; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #444; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="sidebar">
            <h2>Research History</h2>
            <div id="history-list"></div>
        </div>

        <div id="main-content">
            <div id="chat-window">
                <div class="status-indicator" id="statusText">Ready</div>
                <input type="text" id="questionInput" placeholder="Enter a topic to research and rationalize...">
                
                <div class="button-group">
                    <button id="submitButton">Search & Rationalize</button>
                    <button id="stopButton">Stop</button>
                </div>

                <div id="result">The synthesis of web data and AI logic will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        const inputElement = document.getElementById('questionInput');
        const submitBtn = document.getElementById('submitButton');
        const stopBtn = document.getElementById('stopButton');
        const resultDiv = document.getElementById('result');
        const statusText = document.getElementById('statusText');
        const historyList = document.getElementById('history-list');

        let isGenerating = false;
        let chatHistory = JSON.parse(localStorage.getItem('puterSearchHistory') || '[]');

        marked.setOptions({
            highlight: (code, lang) => hljs.highlightAuto(code).value,
            breaks: true
        });

        async function askAI() {
            const query = inputElement.value.trim();
            if (!query || isGenerating) return;

            isGenerating = true;
            submitBtn.disabled = true;
            stopBtn.style.display = "inline-block";
            resultDiv.innerHTML = "";
            
            try {
                // STEP 1: Google Search Access
                statusText.innerText = "ðŸŒ Accessing Google Search...";
                const searchResults = await puter.google.search(query, { limit: 5 });
                
                // Format the search data into a digestible string
                const dataContext = searchResults.map(res => 
                    `Source: ${res.title}\nSnippet: ${res.snippet}\nURL: ${res.link}`
                ).join("\n\n");

                // STEP 2: Construct the Rationalization Prompt
                // This ensures the response isn't "1+1=2" but an "authentic" blend.
                const systemPrompt = `
                    You are an advanced rationalization engine. 
                    USER REQUEST: "${query}"
                    RAW SEARCH DATA:
                    ${dataContext}

                    INSTRUCTION: 
                    Rationalize the user request against the search data. Do not simply summarize. 
                    Blend the facts into a cohesive, "authentic" narrative. If the data conflicts or 
                    adds new dimensions (like 1+1 not being 2 in a specific context), explain that 
                    nuance. Your response should feel like a deep-dive synthesis.
                `;

                statusText.innerText = "ðŸ§  Rationalizing data...";
                const response = await puter.ai.chat(systemPrompt, { model: "gpt-5.2-pro", stream: true });

                let fullText = "";
                for await (const part of response) {
                    if (!isGenerating) break;
                    if (part?.text) {
                        fullText += part.text;
                        resultDiv.innerText = fullText;
                    }
                }

                saveToHistory(query, fullText);

            } catch (error) {
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                renderOutput(resultDiv.innerText);
                statusText.innerText = "Done";
                isGenerating = false;
                submitBtn.disabled = false;
                stopBtn.style.display = "none";
            }
        }

        function renderOutput(text) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = marked.parse(text);
            tempDiv.querySelectorAll('pre').forEach(pre => {
                const container = document.createElement('div');
                container.className = 'code-container';
                const btn = document.createElement('button');
                btn.className = 'copy-btn'; btn.innerText = 'Copy';
                btn.onclick = () => { navigator.clipboard.writeText(pre.innerText); btn.innerText = 'Copied!'; };
                pre.parentNode.insertBefore(container, pre);
                container.appendChild(btn); container.appendChild(pre);
            });
            resultDiv.innerHTML = "";
            resultDiv.appendChild(tempDiv);
            resultDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
        }

        function saveToHistory(q, a) {
            chatHistory.unshift({ q, a });
            localStorage.setItem('puterSearchHistory', JSON.stringify(chatHistory.slice(0, 20)));
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = "";
            chatHistory.forEach((item, i) => {
                const d = document.createElement('div');
                d.className = 'history-item';
                d.innerText = item.q;
                d.onclick = () => renderOutput(item.a);
                historyList.appendChild(d);
            });
        }

        submitBtn.onclick = askAI;
        stopBtn.onclick = () => isGenerating = false;
        inputElement.onkeypress = (e) => { if(e.key === 'Enter') askAI(); };
        window.onload = renderHistory;
    </script>
</body>
</html>
