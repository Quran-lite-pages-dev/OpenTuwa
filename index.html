<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <title>Quran Player with Spanish, Chinese, English & Indonesian Translation</title>
    
    <meta name="description" content="Listen to the Noble Quran verse by verse. Get Arabic text with English, Spanish, Chinese, and Indonesian translations. Features reciter selection and audio translation.">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">

    <link rel="canonical" href="https://muslim1446.github.io/">

    <link rel="alternate" hreflang="x-default" href="https://muslim1446.github.io/">
    <link rel="alternate" hreflang="en" href="https://muslim1446.github.io/">
    <link rel="alternate" hreflang="es" href="https://muslim1446.github.io/">
    <link rel="alternate" hreflang="zh" href="https://muslim1446.github.io/">
    <link rel="alternate" hreflang="id" href="https://muslim1446.github.io/">

    <meta property="og:title" content="Quran Player (Spanish, Chinese, English)">
    <meta property="og:description" content="A verse-by-verse Quran player with Arabic text and translations in Spanish, Chinese, English, and Indonesian.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://muslim1446.github.io/">
    <meta property="og:image" content="https://muslim1446.github.io/social-preview.jpg"> <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="es_ES"> <meta property="og:locale:alternate" content="zh_CN"> <meta property="og:locale:alternate" content="id_ID"> <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Quran Player (Spanish, Chinese, English)">
    <meta name="twitter:description" content="Verse-by-verse Quran player with translations in Spanish, Chinese, English, and Indonesian.">
    <meta name="twitter:image" content="https://muslim1446.github.io/social-preview.jpg">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Multi-lingual Quran Player",
      "description": "A verse-by-verse Quran player offering Arabic text with translations (English, Spanish, Chinese, Indonesian) and audio translations.",
      "url": "https://muslim1446.github.io/",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Any (Web)",
      "browserRequirements": "Requires a modern web browser.",
      
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },

      "featureList": [
        "Verse-by-Verse Audio Playback",
        "Reciter Selection",
        "Arabic Text Display",
        "Audio Translation (English, Indonesian)",
        "Text Translation (English, Spanish, Chinese, Indonesian)"
      ],
      
      "inLanguage": "ar",
      
      "availableLanguage": [
        {
          "@type": "Language",
          "name": "Arabic"
        },
        {
          "@type": "Language",
          "name": "English"
        },
        {
          "@type": "Language",
          "name": "Spanish"
        },
        {
          "@type": "Language",
          "name": "Chinese"
        },
        {
          "@type": "Language",
          "name": "Indonesian"
        }
      ]
    }
    </script>
    
    <link href="data:image/svg+xml,<svg xmlns=%22http://www.w.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>" rel="icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa+Ink:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR6YH9S6MS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BR6YH9S6MS');
    </script>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-54DDMRW8');</script>
    <style>
        /* ... (all styles are the same as before) ... */
        :root { --vh: 100vh; }
        html { box-sizing: border-box; font-size: 62.5%; }
        *, *::before, *::after { box-sizing: inherit; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            color: #ffffff;
            line-height: 1.6;
            font-size: 1.6rem;
            overscroll-behavior: none;
            overflow: hidden; /* No scrolling on the main page */
        }
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: var(--vh, 100vh);
            padding: 2rem;
            padding-bottom: 12rem;
        }
        #content-display {
            text-align: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden; 
        }
        #chapter-title {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1.25rem, 2vw, 2.5rem);
            font-weight: 600;
            color: #bbbbbb;
            position: fixed;
            top: 2rem;
            left: 2rem;
            margin: 0;
            z-index: 1000;
        }
        #verse-text { 
            color: #ffffff;
            margin-bottom: 2.5rem;
            filter: invert(1); 
            width: 100%;
            max-width: 1200px;
            height: auto;
            object-fit: contain;
            flex-grow: 0;
            flex-shrink: 1;
            max-height: 60%;
            overflow: hidden;
            position: relative;
            will-change: auto;
            transition: none !important;
            transform: none !important; 
            backface-visibility: hidden;
            image-rendering: crisp-edges; 
            pointer-events: none;       
        }
        #translation-text {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1.6rem, 2.5vh, 3.5rem);
            font-weight: 1200;
            top: 35%;
            color: #dddddd;
            line-height: 1.7;
            flex-grow: 0;       
            flex-shrink: 1;     
            max-height: 35%;    
            overflow: hidden;   
            white-space: pre-wrap;       
            text-align: center;          
            position: relative;          
            will-change: auto;           
            transition: none !importa_nt; 
            transform: none !important;  
        }  
        #content-overlay {
            position: absolute;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.35); 
            backdrop-filter: blur(2px);      
            pointer-events: none;            
            z-index: 5;                      
            transition: opacity 0.3s ease;
        }
        #control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; 
            gap: 2rem;
            padding: 2.5rem;
            background-color: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            will-change: opacity, transform;
            z-index: 100;
        }
        body.idle #control-panel {
            opacity: 0;
            transform: translateY(100%);
            pointer-events: none;
        }
        #control-panel label {
            font-size: clamp(1.6rem, 2vw, 2.2rem);
            font-weight: 400;
            color: #ccc;
        }
        #control-panel button {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1.8rem, 2.2vw, 2.4rem);
            padding: 1.2rem 2.5rem;
            background-color: #007AFF;
            color: #ffffff;
            border: 1px solid #007AFF;
            border-radius: 12px;
            cursor: pointer;
            min-width: 150px;
        }
        #control-panel select {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1.8rem, 2.2vw, 2.4rem);
            padding: 1.2rem 1.5rem;
            background-color: #333;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 12px;
            cursor: pointer;
            min-width: 200px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1.5rem center;
            background-size: 1.6rem;
            padding-right: 4rem;
        }
        #control-panel select:focus,
        #control-panel button:focus {
            outline: 4px solid #00AFFF;
            outline-offset: 2px;
            box-shadow: 0 0 25px rgba(0, 175, 255, 0.7);
            background-color: #444;
        }
        #verse-text, 
        #verse-text-next {
            transition: opacity 0.3s ease;
            position: absolute;
            top: 15%; 
            left: 0%;
            width: 100%;
            height: auto;
        }
        
        /* --- Hidden Audio Players (from old_index.html) --- */
        #audio-player, #translation-audio-player {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <audio id="audio-player" controls></audio>
        <audio id="translation-audio-player" controls></audio>
        
        <script>
            // ... (script for updateVerse is fine, but unused for now) ...
        </script>
        
        <div id="content-display">
            <h1 id="chapter-title">Loading...</h1>
            <p id="verse-text"></p>
            <img id="verse-text-next" style="display:none;">
            <p id="translation-text"></p>
        </div>
    </div>

    <div id="control-panel">
        <div>
            <label for="chapterSelect"></label>
            <select id="chapterSelect"></select>
        </div>
        <div>
            <label for="verseSelect"></label>
            <select id="verseSelect"></select>
        </div>
        <div>
            <label for="translationSelect"></label>
            <select id="translationSelect"></select>
        </div>
        <div>
            <label for="reciterSelect"></label>
            <select id="reciterSelect"></select>
        </div>
        <div>
            <label for="translationAudioSelect"></label>
            <select id="translationAudioSelect"></select>
        </div>
        <div>
            <button id="play-pause-btn">â–¶</button>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const playPauseBtn = document.getElementById('play-pause-btn');
        const controlPanel = document.getElementById('control-panel');
        
        // RE-ADDED from old_index.html
        const quranAudioPlayer = document.getElementById('audio-player');
        const translationAudioPlayer = document.getElementById('translation-audio-player');
        
        const chapterSelect = document.getElementById('chapterSelect');
        const verseSelect = document.getElementById('verseSelect');
        const translationSelect = document.getElementById('translationSelect');
        const reciterSelect = document.getElementById('reciterSelect');
        const translationAudioSelect = document.getElementById('translationAudioSelect');
        const chapterTitleEl = document.getElementById('chapter-title');
        const translationTextEl = document.getElementById('translation-text');
        const contentDisplayEl = document.getElementById('content-display');

        // --- Configs (Same) ---
        const TRANSLATIONS_CONFIG = {
            'en': { name: 'English (Sahih)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/3TM.xml' },
            'zh': { name: 'ä¸­æ–‡ (Jian)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/zh.jian.xml' },
            'es': { name: 'EspaÃ±ol (Garcia)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/es.garcia.xml' },
            'id': { name: 'Indonesian', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/id.indonesian.xml' }
        };
        const RECITERS_CONFIG = {
            'alafasy': { name: 'Mishary Alafasy', path: 'Alafasy_128kbps' },
            'juhaynee': { name: 'Al Juhany', path: 'Abdullaah_3awwaad_Al-Juhaynee_128kbps' },
            'sudais': { name: 'As Sudais', path: 'Abdurrahmaan_As-Sudais_192kbps' },
            'ghamadi': { name: 'Al Ghamdi', path: 'Ghamadi_40kbps' },
            'abbad': { name: 'Fares Abbad', path: 'Fares_Abbad_64kbps' },
            'muaiqly': { name: 'Al Muaiqly', path: 'MaherAlMuaiqly128kbps' },
            'shuraym': { name: 'Ash Shuraym', path: 'Saood_ash-Shuraym_128kbps' },
            'basit': { name: 'Abdul Basit', path: 'Abdul_Basit_Murattal_192kbps' }
        };
        const TRANSLATION_AUDIO_CONFIG = {
            'none': { name: 'No Audio Translation' },
            'en_walk': { name: 'English (Ibrahim Walk)', path: 'English/Sahih_Intnl_Ibrahim_Walk_192kbps' },
            'id_ministry': { name: 'Indonesian (Ministry)', path: 'httpIA://dn721906.ca.archive.org/0/items/AlQuran-terjemahan-indonesia-tanpa-bahasa-arab' }
        };
        const FTT_URL = 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/FTT.XML';

        // --- Application State ---
        let quranData = []; 
        let allTranslations = {};
        let currentChapterData = {};
        let inactivityTimer;
        let forbiddenToTranslateSet = new Set();
        let isPlaying = false; // State variable to track playback

        // --- Inactivity Timer (Same) ---
        function showControls() {
            document.body.classList.remove('idle');
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                document.body.classList.add('idle');
            }, 5000);
        }

        // --- Core Functions ---

        /**
         * Fetches and initializes all required data
         */
        async function initializeApp() {
            try {
                // 1. Fetch JSON (Same)
                const jsonResponse = await fetch('https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/2TM3TM.json');
                if (!jsonResponse.ok) throw new Error(`HTTP error! status: ${jsonResponse.status} for JSON`);
                const jsonData = await jsonResponse.json();
                quranData = jsonData.chapters;

                // 2. Fetch FTT (Same)
                try {
                    const fttResponse = await fetch(FTT_URL);
                    if (!fttResponse.ok) throw new Error(`HTTP error! status: ${fttResponse.status} for FTT.xml`);
                    const fttString = await fttResponse.text();
                    const parser = new DOMParser();
                    const fttDoc = parser.parseFromString(fttString, 'application/xml');
                    const parserError = fttDoc.querySelector('parsererror');
                    if (parserError) throw new Error("FTT.xml parser error");
                    const verses = fttDoc.querySelectorAll('Verse');
                    verses.forEach(verse => {
                        const chapNum = verse.getAttribute('chapter')?.trim(); 
                        const verseNum = verse.getAttribute('number')?.trim();  
                        if (chapNum && verseNum) forbiddenToTranslateSet.add(`${chapNum}-${verseNum}`);
                    });
                } catch (error) {
                    console.warn("Could not load FTT.xml, proceeding without it.", error);
                }

                // 3. Fetch all translations (Same)
                const translationPromises = Object.entries(TRANSLATIONS_CONFIG).map(async ([id, config]) => {
                    try {
                        const response = await fetch(config.url);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${config.name}`);
                        const xmlString = await response.text();
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlString, 'application/xml');
                        return { id, xmlDoc };
                    } catch (error) {
                        console.error(`Failed to load ${config.name}:`, error);
                        return { id, xmlDoc: null };
                    }
                });
                const settledTranslations = await Promise.all(translationPromises);

                // 4. Store translations (Same)
                allTranslations = {};
                translationSelect.innerHTML = '';
                settledTranslations.forEach(result => {
                    if (result.xmlDoc) {
                        allTranslations[result.id] = result.xmlDoc;
                        const option = document.createElement('option');
                        option.value = result.id;
                        option.textContent = TRANSLATIONS_CONFIG[result.id].name;
                        translationSelect.appendChild(option);
                    }
                });
                if (Object.keys(allTranslations).length === 0) throw new Error("Failed to load any translations.");

                // 5. Populate other selectors (Same)
                populateReciterSelect();
                populateTranslationAudioSelect();
                populateChapterSelect();
                populateVerseSelect(); 
                
                // 6. Load first verse (but don't play)
                loadVerse(false); // Don't auto-play on load
                
                // 7. Set up event listeners *after* data is loaded
                // MODIFIED: All selects now call loadVerse(true) to auto-play
                chapterSelect.addEventListener('change', () => {
                    populateVerseSelect();
                    loadVerse(true); // Auto-play on chapter change
                });
                verseSelect.addEventListener('change', () => loadVerse(true)); // Auto-play on verse change
                translationSelect.addEventListener('change', updateTranslationText); // Text only
                reciterSelect.addEventListener('change', () => loadVerse(true)); // Auto-play on reciter change
                translationAudioSelect.addEventListener('change', () => loadVerse(true)); // Auto-play on translation audio change

                // Button listener
                playPauseBtn.addEventListener('click', togglePlayPause);

                // Inactivity and keydown listeners
                document.addEventListener('mousemove', showControls);
                document.addEventListener('touchstart', showControls);
                document.addEventListener('click', showControls);
                document.addEventListener('keydown', handleKeydown);
                showControls(); // Show controls on start

                // ADDED: Listeners from old_index.html for audio events
                quranAudioPlayer.addEventListener('ended', handleQuranAudioEnd);
                translationAudioPlayer.addEventListener('ended', playNextVerse);

                // ADDED: Robust state tracking based on player events
                quranAudioPlayer.addEventListener('play', () => {
                    isPlaying = true;
                    playPauseBtn.textContent = 'â¸';
                });
                quranAudioPlayer.addEventListener('pause', () => {
                    isPlaying = false;
                    playPauseBtn.textContent = 'â–¶';
                });


            } catch (error) {
                console.error("Failed to load Qur'an data:", error);
                contentDisplayEl.innerHTML = `
                    <h1 id="chapter-title">Error</h1>
                    <p id="translation-text">Failed to load Qur'an data. Please check your internet connection and refresh the page.</p>
                `;
            }
        }

        // --- (populate... functions are all THE SAME) ---
        function populateChapterSelect() {
            chapterSelect.innerHTML = '';
            quranData.forEach((chapter, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${chapter.chapterNumber}. ${chapter.title} `;
                chapterSelect.appendChild(option);
            });
        }
        function populateVerseSelect() {
            verseSelect.innerHTML = '';
            const chapterIndex = chapterSelect.value || 0;
            currentChapterData = quranData[chapterIndex]; 
            currentChapterData.verses.forEach((verse, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Ayat ${verse.verseNumber}`;
                verseSelect.appendChild(option);
            });
        }
        function populateReciterSelect() {
            reciterSelect.innerHTML = '';
            Object.entries(RECITERS_CONFIG).forEach(([id, config]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = config.name;
                reciterSelect.appendChild(option);
            });
        }
        function populateTranslationAudioSelect() {
            translationAudioSelect.innerHTML = '';
            Object.entries(TRANSLATION_AUDIO_CONFIG).forEach(([id, config]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = config.name;
                translationAudioSelect.appendChild(option);
            });
        }
        
        // --- (updateTranslationText is THE SAME) ---
        function updateTranslationText() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;
            const translationId = translationSelect.value; 
            if (!quranData[chapterIndex] || !quranData[chapterIndex].verses[verseIndex] || !translationId) return;
            const chapNum = quranData[chapterIndex].chapterNumber;
            const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
            const verseKey = `${chapNum}-${verseNum}`;
            if (forbiddenToTranslateSet.has(verseKey)) {
                translationTextEl.textContent = '';
                adjustTranslationFontSize();
                return;
            }
            const selectedTranslationXML = allTranslations[translationId]; 
            let translation = "Translation not found.";
            if (selectedTranslationXML) {
                const suraElement = selectedTranslationXML.querySelector(`sura[index="${chapNum}"]`);
                if (suraElement) {
                    const ayaElement = suraElement.querySelector(`aya[index="${verseNum}"]`);
                    if (ayaElement) translation = ayaElement.getAttribute('text');
                }
            }
            translationTextEl.textContent = translation;
            adjustTranslationFontSize();
        }

        // --- RE-ADDED AUDIO FUNCTIONS (from old_index.html) ---

        /**
         * Updates *only* the QUR'AN audio source
         */
        function updateQuranAudio() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;
            const reciterId = reciterSelect.value;
            if (!quranData[chapterIndex] || !quranData[chapterIndex].verses[verseIndex] || !reciterId) return;

            const chapNum = quranData[chapterIndex].chapterNumber;
            const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
            const reciterPath = RECITERS_CONFIG[reciterId].path;
            const chapterStr = String(chapNum).padStart(3, '0');
            const verseStr = String(verseNum).padStart(3, '0');
            
            const newAudioUrl = `https://everyayah.com/data/${reciterPath}/${chapterStr}${verseStr}.mp3`;
            
            if (quranAudioPlayer.src !== newAudioUrl) {
                quranAudioPlayer.src = newAudioUrl;
            }
        }

        /**
         * Updates *only* the TRANSLATION audio source
         */
        function updateTranslationAudio() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;

            if (quranData[chapterIndex] && quranData[chapterIndex].verses[verseIndex]) {
                 const chapNum = quranData[chapterIndex].chapterNumber;
                 const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
                 const verseKey = `${chapNum}-${verseNum}`;
                 if (forbiddenToTranslateSet.has(verseKey)) {
                    translationAudioPlayer.src = ''; // Clear src
                    return;
                 }
            }

            const translationAudioId = translationAudioSelect.value;
            if (translationAudioId === 'none') {
                translationAudioPlayer.src = '';
                return;
            }
            if (!quranData[chapterIndex] || !quranData[chapterIndex].verses[verseIndex]) return;

            const chapNum = quranData[chapterIndex].chapterNumber;
            const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
            const config = TRANSLATION_AUDIO_CONFIG[translationAudioId];
            const chapterStr = String(chapNum).padStart(3, '0');
            const verseStr = String(verseNum).padStart(3, '0');
            
            let newAudioUrl;
            if (config.path.startsWith('httpIA')) { 
                newAudioUrl = `${config.path.replace('httpIA', 'https')}/${chapterStr}${verseStr}.mp3`;
            } else {
                newAudioUrl = `https://everyayah.com/data/${config.path}/${chapterStr}${verseStr}.mp3`;
            }

            if (translationAudioPlayer.src !== newAudioUrl) {
                translationAudioPlayer.src = newAudioUrl;
            }
        }

        /**
         * Loads the selected verse (image) and tells HTML Audio to play if requested.
         * @param {boolean} shouldPlay - Whether to start playback.
         */
        function loadVerse(shouldPlay) {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;
            
            currentChapterData = quranData[chapterIndex];
            let verseData = currentChapterData.verses[verseIndex]; 

            const chapNum = currentChapterData.chapterNumber;
            const verseNum = verseData.verseNumber;
            const verseKey = `${chapNum}-${verseNum}`;
            const isForbidden = forbiddenToTranslateSet.has(verseKey);

            // --- Update Chapter Title ---
            chapterTitleEl.textContent = `${currentChapterData.title} (${chapNum})`;

            // --- Display Arabic as an Image ---
            const oldVerseEl = document.getElementById('verse-text');
            const verseImage = document.createElement('img');
            verseImage.id = 'verse-text';
            verseImage.src = `https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/img/${chapNum}_${verseNum}.png`;
            verseImage.alt = `Surah ${chapNum}, Verse ${verseNum}`;
            
            if (oldVerseEl) {
                oldVerseEl.parentNode.replaceChild(verseImage, oldVerseEl);
            } else {
                contentDisplayEl.insertBefore(verseImage, translationTextEl);
            }

            // --- Update Translation Text ---
            if (isForbidden) {
                translationTextEl.textContent = '';
            } else {
                updateTranslationText();
            }
            
            // --- Update Page Title ---
            updateTitle();
            
            // --- Update Audio Sources ---
            updateQuranAudio();
            if (isForbidden) {
                translationAudioPlayer.src = '';
            } else {
                updateTranslationAudio();
            }
            
            // --- Update Media Session ---
            updateMediaSession();

            // --- Play if requested ---
            if (shouldPlay) {
                quranAudioPlayer.play().catch(e => console.warn("Audio autoplay blocked.", e));
            }
        }

        /**
         * NEW: Toggles Play/Pause
         */
        function togglePlayPause() {
            if (quranAudioPlayer.paused) {
                quranAudioPlayer.play().catch(e => console.warn("Audio play failed.", e));
            } else {
                quranAudioPlayer.pause();
                translationAudioPlayer.pause(); // Also pause translation if it's playing
            }
        }
        
        /**
         * RE-ADDED: Handles when the *Qur'an* audio finishes playing.
         */
        function handleQuranAudioEnd() {
            const translationAudioId = translationAudioSelect.value;
            
            if (translationAudioId === 'none' || translationAudioPlayer.src === '' || translationAudioPlayer.src.endsWith('/')) {
                playNextVerse();
            } else {
                translationAudioPlayer.play().catch(e => {
                    console.warn("Translation audio playback failed.", e);
                    playNextVerse();
                });
            }
        }

        /**
         * RE-ADDED: Automatically advances to the next verse.
         */
        function playNextVerse() {
            let currentChapterIndex = parseInt(chapterSelect.value);
            let currentVerseIndex = parseInt(verseSelect.value);

            const totalVersesInChapter = verseSelect.options.length;
            const totalChapters = chapterSelect.options.length;

            let nextVerseIndex = currentVerseIndex + 1;
            let nextChapterIndex = currentChapterIndex;

            if (nextVerseIndex >= totalVersesInChapter) {
                nextVerseIndex = 0;
                nextChapterIndex = currentChapterIndex + 1;

                if (nextChapterIndex >= totalChapters) {
                    console.log("End of Qur'an playback.");
                    isPlaying = false;
                    playPauseBtn.textContent = 'â–¶';
                    return; // Stop at the end
                }
                
                chapterSelect.value = nextChapterIndex;
                populateVerseSelect();
            }

            verseSelect.value = nextVerseIndex;
            loadVerse(true); // Load AND PLAY the next verse
        }
        
        /**
         * RE-ADDED: Updates the OS-level Media Session
         */
        function updateMediaSession() {
            if ('mediaSession' in navigator && currentChapterData && currentChapterData.verses) {
                const verseIndex = verseSelect.value || 0;
                const verseNum = currentChapterData.verses[verseIndex].verseNumber;
                const reciterId = reciterSelect.value;
                const reciterName = RECITERS_CONFIG[reciterId] ? RECITERS_CONFIG[reciterId].name : 'Qur\'an';

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `Ayat ${verseNum}`,
                    artist: reciterName, 
                    album: `Surah ${currentChapterData.title}`,
                });
            }
        }


        // --- (adjustTranslationFontSize is THE SAME) ---
        function adjustTranslationFontSize() {
            const el = translationTextEl;
            if (!el) return;
            const minFontSizePx = 1.6 * 10;
            const vhInPx = window.innerHeight * 0.025;
            const remInPx = 3.5 * 10;
            const maxFontSizePx = Math.min(vhInPx, remInPx);
            el.style.fontSize = `${maxFontSizePx}px`;
            let currentFontSize = maxFontSizePx;
            let iterations = 0;
            const maxIterations = 50; 
            while (el.scrollHeight > el.clientHeight && iterations < maxIterations) {
                currentFontSize -= 1; 
                if (currentFontSize < minFontSizePx) {
                    el.style.fontSize = `${minFontSizePx}px`;
                    break; 
                }
                el.style.fontSize = `${currentFontSize}px`;
                iterations++;
            }
        }
        
        // --- (updateTitle is THE SAME) ---
        function updateTitle() {
            const chapterIndex = chapterSelect.value || 0;
            const verseIndex = verseSelect.value || 0;
            if (!quranData[chapterIndex]) return;
            const chapNum = quranData[chapterIndex].chapterNumber;
            const verseNum = quranData[chapterIndex].verses[verseIndex].verseNumber;
            document.title = `(${chapNum}:${verseNum}) Qur'an`;
        }

        /**
         * (handleKeydown is THE SAME)
         */
        function handleKeydown(event) {
            showControls(); // Show controls on any key press
            const isControlFocused = controlPanel.contains(document.activeElement);
            if (isControlFocused && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                event.preventDefault();
            }
        }
        
        // --- Startup ---
        initializeApp();

    </script>
</body>
</html>
