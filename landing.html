<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tuwa - Premium Access</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/index1.css">
    <link rel="stylesheet" href="styles/inline-styles.css">
    
    <style>
        body { background: #000; overflow: hidden; }
        /* Landing Page Specific Overrides to match index1.css variable usage */
        #premium-landing { display: flex !important; }
    </style>
</head>
<body>

    <div id="premium-landing" style="display: flex;"> 
        <div class="premium-brand-replica">
            <img src="assets/ui/logo.png" alt="Tuwa Logo">
            <span>Tuwa</span>
        </div>

        <div class="premium-content">
            <div class="appx-brand" aria-label="Tuwa Home">
                <div class="brand-icon">
                    <img src="assets/ui/logo.png" alt="Tuwa Logo">
                </div>
                <span class="brand-text">Tuwa</span>
            </div>
            <h1 class="premium-title">Access to premium content with distraction-free viewing.</h1>
            <p class="premium-subtitle">Premium streaming platform — <b>1.5 billion listeners daily</b></p>

            <div class="premium-card-wrapper">
                <div class="premium-price-tag">
                    <span class="price-period"></span>
                    <span class="price-big">USD 0</span> 
                    <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 4px;">
                        <span class="price-term-common" style="color: #fff;">Premium Plan • <b>12 Months</b> (Limited time offer)</span>
                        <span class="price-term-common"></span>
                        <button id="premium-start-btn" class="premium-btn">Start watching for free</button>
                        <nobr><span class="price-term">No credit card needed</span></nobr>
                    </div>
                </div>
            </div>
            
            <p class="premium-legal-disclaimer">
                *Promotional pricing of USD 0/mo valid for the initial 12-month term. Plan automatically continues at the standard zero-cost rate thereafter. No commitment; cancel anytime. No payment method required.
            </p>
        </div>

        <div class="premium-processing">
            <div class="premium-loader"></div>
            <div class="premium-status-text" id="premium-status">Confirming availability</div>
        </div>

        <div id="legal-overlay" class="legal-backdrop">
            <div class="legal-glass-panel">
                <button class="legal-close" onclick="closeLegal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg>
                </button>
                <div id="legal-content-area" class="legal-scroll-content"></div>
            </div>
        </div>
    </div>

    <!-- Hybrid Auth Modal (Used by the 'Start watching for free' flow) -->
    <div id="hybrid-auth-modal">
        <div class="auth-card">
            <h2 class="auth-card-title" style="color:#fff; margin:0; font-family:'Inter',sans-serif;">Your bespoke premium content is on its way.</h2>
            <div id="auth-error"></div>

            <button onclick="handleSocialLogin('google')" class="social-btn btn-google">
                <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
                Continue with Google
            </button>
            <!-- Other buttons kept for visual fidelity -->
            <button class="social-btn btn-discord" style="opacity:0.5; cursor:not-allowed;">Discord (Coming Soon)</button>

            <div style="margin-top:20px; font-size:0.8rem; color:#444; cursor:pointer;" onclick="closeAuth()">Cancel</div>
        </div>
    </div>

    <!-- Styles for Auth/Legal/Processing -->
    <style>
        /* Reused from original index.html */
        .legal-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9995; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); opacity: 0; pointer-events: none; transition: opacity 0.4s; display: flex; align-items: center; justify-content: center; }
        .legal-backdrop.active { opacity: 1; pointer-events: all; }
        .legal-glass-panel { width: 90%; max-width: 600px; height: 80vh; background: rgba(20, 20, 20, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 40px 80px rgba(0,0,0,0.8); transform: scale(0.95) translateY(20px); transition: transform 0.5s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .legal-backdrop.active .legal-glass-panel { transform: scale(1) translateY(0); }
        .legal-scroll-content { padding: 40px; overflow-y: auto; color: #f0f0f0; font-family: "Plus Jakarta Sans", sans-serif; font-size: 1.4rem; line-height: 1.8; }
        .legal-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; border-radius: 50%; width: 36px; height: 36px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; z-index: 10; }
        
        #hybrid-auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2147483647; display: none; justify-content: center; align-items: center; backdrop-filter: blur(15px); opacity: 0; transition: opacity 0.4s ease; }
        #hybrid-auth-modal.visible { opacity: 1; pointer-events: all; }
        .auth-card { background: rgba(20, 20, 20, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 40px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 40px 80px rgba(0,0,0,1); display: flex; flex-direction: column; gap: 12px; transform: scale(0.95); transition: transform 0.3s; }
        #hybrid-auth-modal.visible .auth-card { transform: scale(1); }
        .social-btn { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s, background 0.2s; color: #fff; font-family: 'Inter', sans-serif; }
        .social-btn:hover { transform: scale(1.02); }
        .btn-google { background: linear-gradient(180deg, #FFFFFF 10%, #888888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; color: #000; }
        
        .premium-processing { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; opacity: 0; transition: opacity 0.6s cubic-bezier(0.2, 0, 0, 1); background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(40px) saturate(120%); }
        .premium-processing.active { display: flex; opacity: 1; }
        .premium-content.fade-out { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .premium-loader { width: 50px; height: 50px; border-radius: 50%; background: conic-gradient(from 0deg, transparent 0%, rgba(255,255,255,0.1) 50%, #fff 100%); -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 2px), #fff calc(100% - 2px + 0.5px)); mask: radial-gradient(farthest-side, transparent calc(100% - 2px), #fff calc(100% - 2px + 0.5px)); animation: cinema-spin 1s linear infinite; margin-bottom: 24px; box-shadow: 0 0 30px rgba(255,255,255,0.05); }
        @keyframes cinema-spin { to { transform: rotate(360deg); } }
        .premium-status-text { animation: text-pulse 2s ease-in-out infinite; transition: opacity 0.3s ease; font-family: "Plus Jakarta Sans", "Inter", sans-serif; font-size: 1.2rem; font-weight: 500; letter-spacing: 0.15em; color: rgba(255, 255, 255, 0.9); text-transform: uppercase; text-align: center; }
        @keyframes text-pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; text-shadow: 0 0 15px rgba(255,255,255,0.3); } }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    (async function() {
        const SUPABASE_URL = 'https://csuyapzneytubzdrdegl.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzdXlhcHpuZXl0dWJ6ZHJkZWdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MzM1MzMsImV4cCI6MjA4NTMwOTUzM30.m5lhtxB-9Wutmt1E-3mlO8R0KlgE8YNXaPP1_UJF2k0';
        
        // Currency Data
        const COUNTRY_TO_CURRENCY = { "AF": "AFN", "AL": "ALL", "DZ": "DZD", "AS": "USD", "AD": "EUR", "AO": "AOA", "AI": "XCD", "AQ": "USD", "AG": "XCD", "AR": "ARS", "AM": "AMD", "AW": "AWG", "AU": "AUD", "AT": "EUR", "AZ": "AZN", "BS": "BSD", "BH": "BHD", "BD": "BDT", "BB": "BBD", "BY": "BYN", "BE": "EUR", "BZ": "BZD", "BJ": "XOF", "BM": "BMD", "BT": "BTN", "BO": "BOB", "BQ": "USD", "BA": "BAM", "BW": "BWP", "BV": "NOK", "BR": "BRL", "IO": "USD", "BN": "BND", "BG": "BGN", "BF": "XOF", "BI": "BIF", "CV": "CVE", "KH": "KHR", "CM": "XAF", "CA": "CAD", "KY": "KYD", "CF": "XAF", "TD": "XAF", "CL": "CLP", "CN": "CNY", "CX": "AUD", "CC": "AUD", "CO": "COP", "KM": "KMF", "CD": "CDF", "CG": "XAF", "CK": "NZD", "CR": "CRC", "HR": "EUR", "CU": "CUP", "CW": "ANG", "CY": "EUR", "CZ": "CZK", "CI": "XOF", "DK": "DKK", "DJ": "DJF", "DM": "XCD", "DO": "DOP", "EC": "USD", "EG": "EGP", "SV": "USD", "GQ": "XAF", "ER": "ERN", "EE": "EUR", "SZ": "SZL", "ET": "ETB", "FK": "FKP", "FO": "DKK", "FJ": "FJD", "FI": "EUR", "FR": "EUR", "GF": "EUR", "PF": "XPF", "TF": "EUR", "GA": "XAF", "GM": "GMD", "GE": "GEL", "DE": "EUR", "GH": "GHS", "GI": "GIP", "GR": "EUR", "GL": "DKK", "GD": "XCD", "GP": "EUR", "GU": "USD", "GT": "GTQ", "GG": "GBP", "GN": "GNF", "GW": "XOF", "GY": "GYD", "HT": "HTG", "HM": "AUD", "VA": "EUR", "HN": "HNL", "HK": "HKD", "HU": "HUF", "IS": "ISK", "IN": "INR", "ID": "IDR", "IR": "IRR", "IQ": "IQD", "IE": "EUR", "IM": "GBP", "IL": "ILS", "IT": "EUR", "JM": "JMD", "JP": "JPY", "JE": "GBP", "JO": "JOD", "KZ": "KZT", "KE": "KES", "KI": "AUD", "KP": "KPW", "KR": "KRW", "KW": "KWD", "KG": "KGS", "LA": "LAK", "LV": "EUR", "LB": "LBP", "LS": "LSL", "LR": "LRD", "LY": "LYD", "LI": "CHF", "LT": "EUR", "LU": "EUR", "MO": "MOP", "MG": "MGA", "MW": "MWK", "MY": "MYR", "MV": "MVR", "ML": "XOF", "MT": "EUR", "MH": "USD", "MQ": "EUR", "MR": "MRU", "MU": "MUR", "YT": "EUR", "MX": "MXN", "FM": "USD", "MD": "MDL", "MC": "EUR", "MN": "MNT", "ME": "EUR", "MS": "XCD", "MA": "MAD", "MZ": "MZN", "MM": "MMK", "NA": "NAD", "NR": "AUD", "NP": "NPR", "NL": "EUR", "NC": "XPF", "NZ": "NZD", "NI": "NIO", "NE": "XOF", "NG": "NGN", "NU": "NZD", "NF": "AUD", "MK": "MKD", "MP": "USD", "NO": "NOK", "OM": "OMR", "PK": "PKR", "PW": "USD", "PS": "ILS", "PA": "PAB", "PG": "PGK", "PY": "PYG", "PE": "PEN", "PH": "PHP", "PN": "NZD", "PL": "PLN", "PT": "EUR", "PR": "USD", "QA": "QAR", "RE": "EUR", "RO": "RON", "RU": "RUB", "RW": "RWF", "BL": "EUR", "SH": "SHP", "KN": "XCD", "LC": "XCD", "MF": "EUR", "PM": "EUR", "VC": "XCD", "WS": "WST", "SM": "EUR", "ST": "STN", "SA": "SAR", "SN": "XOF", "RS": "RSD", "SC": "SCR", "SL": "SLE", "SG": "SGD", "SX": "ANG", "SK": "EUR", "SI": "EUR", "SB": "SBD", "SO": "SOS", "ZA": "ZAR", "GS": "GBP", "SS": "SSP", "ES": "EUR", "LK": "LKR", "SD": "SDG", "SR": "SRD", "SJ": "NOK", "SE": "SEK", "CH": "CHF", "SY": "SYP", "TW": "TWD", "TJ": "TJS", "TZ": "TZS", "TH": "THB", "TL": "USD", "TG": "XOF", "TK": "NZD", "TO": "TOP", "TT": "TTD", "TN": "TND", "TR": "TRY", "TM": "TMT", "TC": "USD", "TV": "AUD", "UG": "UGX", "UA": "UAH", "AE": "AED", "GB": "GBP", "US": "USD", "UM": "USD", "UY": "UYU", "UZ": "UZS", "VU": "VUV", "VE": "VES", "VN": "VND", "VG": "USD", "VI": "USD", "WF": "XPF", "EH": "MAD", "YE": "YER", "ZM": "ZMW", "ZW": "ZWG" };

        let supabase = null;
        let session = null;
        
        try {
            if (window.supabase) {
                const { createClient } = window.supabase;
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) { console.error("Supabase Init Error", e); }

        const startBtn = document.getElementById('premium-start-btn');
        const authModal = document.getElementById('hybrid-auth-modal');
        const premiumContent = document.querySelector('.premium-content');
        const premiumProcessing = document.querySelector('.premium-processing');
        const statusText = document.getElementById('premium-status');

        // Currency Loading
        const paintPrice = (currency) => {
            const priceTag = document.querySelector('.price-big');
            if (priceTag) {
                priceTag.innerText = currency + " 0.00"; 
                priceTag.classList.add('loaded'); 
            }
        };

        paintPrice('USD'); 

        fetch('/cdn-cgi/trace')
            .then(r => { if (!r.ok) throw new Error("CF Trace failed"); return r.text(); })
            .then(text => { 
                const match = text.match(/loc=([A-Z]{2})/);
                const country = match ? match[1] : 'US';
                const currency = COUNTRY_TO_CURRENCY[country] || 'USD';
                paintPrice(currency); 
            })
            .catch(() => paintPrice('USD'));

        // Check Auth
        if (supabase) {
            const { data } = await supabase.auth.getSession();
            if (data && data.session) {
                initializePostLogin();
            } else {
                initializeGuest();
            }
        } else {
            initializeGuest();
        }

        function initializeGuest() {
            if (startBtn) {
                startBtn.innerText = "Start watching for free";
                startBtn.onclick = () => {
                    authModal.style.display = 'flex';
                    setTimeout(() => authModal.classList.add('visible'), 10);
                };
            }
        }

        function initializePostLogin() {
            if (startBtn) {
                startBtn.innerText = "Activate Premium"; 
                startBtn.style.background = "#fff"; 
                startBtn.style.color = "#000";
                startBtn.style.fontWeight = "700";
                
                const terms = document.querySelectorAll('.price-term, .price-term-common');
                terms.forEach(t => t.style.opacity = '0'); 

                startBtn.onclick = runOTTSequence;
            }
        }

        async function runOTTSequence() {
            // Visuals
            premiumContent.classList.add('fade-out');
            premiumProcessing.classList.add('active');

            const steps = [
                { text: "Confirming subscription", delay: 800 },
                { text: "Verifying your device", delay: 2000 },
                { text: "Personalizing your library", delay: 3800 },
                { text: "Welcome to Tuwa", delay: 6500 }
            ];

            steps.forEach(step => {
                setTimeout(() => {
                    if (statusText) {
                        statusText.style.opacity = 0; 
                        setTimeout(() => {
                            statusText.innerText = step.text;
                            statusText.style.opacity = 1;
                        }, 200);
                    }
                }, step.delay);
            });

            // ... inside runOTTSequence ...

            // SECURE AUTH REQUEST
            setTimeout(async () => {
                try {
                    const response = await fetch('/login', { method: 'POST' });
                    if (response.ok) {
                         // CHANGED: Force a hard navigation to root instead of reload()
                         // We add a timestamp (?t=...) to bust the browser cache 
                         // and ensure the middleware runs again.
                         window.location.href = "/?t=" + new Date().getTime();
                    } else {
                        alert("Activation Failed. Please refresh.");
                        window.location.reload();
                    }
                } catch (e) {
                    console.error("Auth Error", e);
                    // Optional: Remove the loading state if it fails so they can try again
                    premiumProcessing.classList.remove('active');
                    premiumContent.classList.remove('fade-out');
                }
            }, 7200);
        }

        window.handleSocialLogin = async (provider) => {
            if (!supabase) return;
            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: provider,
                    options: { redirectTo: window.location.href }
                });
                if (error) throw error;
            } catch (err) {
                console.error(err);
            }
        };

        window.closeAuth = () => {
            authModal.classList.remove('visible');
            setTimeout(() => authModal.style.display = 'none', 300);
        };
        
        // Legal Overlay Logic
        window.openLegal = (type) => { /* Reuse logic if needed, simplified for brief */ };
        window.closeLegal = () => document.getElementById('legal-overlay').classList.remove('active');
    })();
    </script>
</body>
</html>